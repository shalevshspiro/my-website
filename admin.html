<!DOCTYPE html>
<html lang="he">
<head>
  <script>
    firebase.auth().onAuthStateChanged(user => {
      if (!user || user.email !== "shalev6005@gmail.com") {
        window.location.href = "https://www.youtube.com/watch?v=Z6hLOCKTpsg&t=937s";
      }
    });
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>× ×™×”×•×œ ×›×ª×‘×•×ª - My Mind</title>
  <link rel="stylesheet" href="css/admin.css">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/admin.js" defer></script>
</head>
<body>
<a href="index.html" class="back-link">â† ×—×–×¨×” ×œ×¢××•×“ ×”×¨××©×™</a>

<h2>ğŸ”‘ ×”×ª×—×‘×¨×•×ª ×œ× ×™×”×•×œ ×›×ª×‘×•×ª</h2>
<form id="loginForm">
  <input type="email" id="email" placeholder="××™××™×™×œ" required>
  <input type="password" id="password" placeholder="×¡×™×¡××”" required>
  <button type="submit">ğŸ“Œ ×”×ª×—×‘×¨</button>
</form>

<button id="logout" style="display:none;">ğŸšª ×”×ª× ×ª×§</button>

<div id="adminPanel" style="display:none;">
  <h2>ğŸ“ ×”×•×¡×¤×ª ×›×ª×‘×” ×—×“×©×”</h2>
  <form id="articleForm">
    <label>ğŸ”¹ ×›×•×ª×¨×ª ×”×›×ª×‘×”:</label>
    <input type="text" id="title" placeholder="×›×•×ª×¨×ª" required>

    <label>ğŸ“– ×”×§×“××”:</label>
    <input type="text" id="intro" placeholder="×”×§×“××”">

    <label>ğŸ“‚ ×§×˜×’×•×¨×™×”:</label>
    <select id="category">
      <option value="articles">×›×ª×‘×•×ª</option>
      <option value="life">×—×™×™×</option>
    </select>

    <label>ğŸ­ ×–'×× ×¨:</label>
    <select id="genre"></select>

    <label>ğŸ““ ×ª×•×›×Ÿ ×”×›×ª×‘×”:</label>
    <div id="editor" style="height: 300px;"></div>

    <label>ğŸ“„ ×˜×¢×Ÿ ×›×ª×‘×” ××§×•×‘×¥:</label>
    <input type="file" id="articleFileInput" accept=".txt,.docx">
    <button type="button" id="loadFromFileBtn">×˜×¢×Ÿ ×›×ª×‘×”</button>

    <label>ğŸ—¼ï¸ ×”×¢×œ××ª ×ª××•× ×•×ª × ×•×¡×¤×•×ª:</label>
    <input type="file" id="imageUpload" multiple>
    <button type="button" id="uploadImagesBtn">ğŸ“„ ×”×¢×œ×” ×ª××•× ×•×ª</button>
    <br>

    <label>ğŸ“ ×”×•×¡×£ ×ª××•× ×” ×œ×¤×™ ×§×™×©×•×¨:</label>
    <input type="text" id="imageUrlInput" placeholder="×”×“×‘×§ ×§×™×©×•×¨ ×œ×ª××•× ×” ×Ö¾Cloudinary">
    <button type="button" id="addImageByUrl">ğŸ“ ×”×•×¡×£ ×ª××•× ×” ××§×™×©×•×¨</button>
    <br>

    <div id="imagePreviewArea" style="margin-top: 20px;"></div>

    <label>ğŸ”– ×ª××•× ×ª ×œ×•×’×•:</label>
    <input type="file" id="logoUpload">
    <button type="button" id="uploadLogoBtn">ğŸ“„ ×”×¢×œ×” ×œ×•×’×•</button>
    <br>
    <input type="text" id="logoImage" placeholder="××• ×”×“×‘×§ ×›××Ÿ ×§×™×©×•×¨ ×œ×ª××•× ×ª ×œ×•×’×• ××´Cloudinary">

    <button type="submit">âœ… ×¦×•×¨ ×›×ª×‘×”</button>
  </form>
</div>

<!-- Quill Scripts -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    window.quill = new Quill("#editor", {
      theme: "snow",
      placeholder: "×›×ª×•×‘ ×›××Ÿ ××ª ×ª×•×›×Ÿ ×”×›×ª×‘×”..."
    });

    document.getElementById("loadFromFileBtn").addEventListener("click", () => {
      const fileInput = document.getElementById("articleFileInput");
      const file = fileInput.files[0];
      if (!file) return alert("×™×© ×œ×‘×—×•×¨ ×§×•×‘×¥ ×§×•×“×");

      const reader = new FileReader();

      if (file.name.endsWith(".txt")) {
        reader.onload = () => {
          quill.root.innerHTML = reader.result
            .split(/\n\n+/)
            .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`)
            .join('');
        };
        reader.readAsText(file);
      } else if (file.name.endsWith(".docx")) {
        reader.onload = () => {
          mammoth.convertToHtml({ arrayBuffer: reader.result })
            .then(result => {
              quill.root.innerHTML = result.value;
            })
            .catch(err => alert("×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ Word"));
        };
        reader.readAsArrayBuffer(file);
      } else {
        alert("×¤×•×¨××˜ ×§×•×‘×¥ ×œ× × ×ª××š. × × ×œ×”×¢×œ×•×ª ×§×•×‘×¥ .txt ××• .docx ×‘×œ×‘×“.");
      }
    });

    const form = document.getElementById("articleForm");
    form.addEventListener("submit", function () {
      let raw = quill.root.innerHTML;
      raw = raw
        .replace(/<p><br><\/p>/g, '___PARAGRAPH___')
        .replace(/<\/p><p>/g, '<br>')
        .replace(/^<p>/, '')
        .replace(/<\/p>$/, '')
        .replace(/<\/p>/g, '')
        .replace(/<p>/g, '')
        .replace(/___PARAGRAPH___/g, '</p><p>');
      const finalContent = `<p>${raw}</p>`;

      const hiddenInput = document.createElement("input");
      hiddenInput.type = "hidden";
      hiddenInput.name = "content";
      hiddenInput.id = "content";
      hiddenInput.value = finalContent;
      form.appendChild(hiddenInput);
    });
  });
</script>
</body>
</html>
